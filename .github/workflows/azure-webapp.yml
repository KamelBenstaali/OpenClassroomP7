name: Deploy FastAPI to Azure Web App

on:
  push:
    branches: [ main ]  # ou ta branche
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      APP_NAME: AirParadisAPI            # nom exact de ton App Service
      RESOURCE_GROUP: DefaultResourceGroup-CCAN  # groupe de ressources Azure
      APP_SERVICE_PLAN: ASP-DefaultResourceGroupCCAN-a48d  # plan App Service
      AZURE_LOCATION: canadacentral                  # r√©gion
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies (minimal) & tests
        run: |
          python -m pip install --upgrade pip
          pip install -r app/FastApi/requirements.txt pytest
          export PYTHONPATH="$PWD"
          APP_TEST_MODE=1 APPLICATIONINSIGHTS_CONNECTION_STRING=test pytest tests/test_main.py

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}   # JSON SPN: {clientId, clientSecret, subscriptionId, tenantId}

      - name: Deploy with az webapp up
        run: |
          az webapp up \
            --name "${{ env.APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --plan "${{ env.APP_SERVICE_PLAN }}" \
            --sku F1 \
            --runtime "PYTHON:3.10" \
            --location "${{ env.AZURE_LOCATION }}"

      - name: Configure app settings and startup command
        run: |
          az webapp config appsettings set \
            -g "${{ env.RESOURCE_GROUP }}" \
            -n "${{ env.APP_NAME }}" \
            --settings WEBSITES_PORT=8000 APP_TEST_MODE=1
          az webapp config set \
            -g "${{ env.RESOURCE_GROUP }}" \
            -n "${{ env.APP_NAME }}" \
            --startup-file "python -m uvicorn app.FastApi.main:app --host 0.0.0.0 --port 8000"
